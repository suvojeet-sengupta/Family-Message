name: ğŸš€ Flutter Build, Release & Notify

on:
  push:
    branches:
      - main
      - stable
  pull_request:
    branches:
      - main
      - stable
  workflow_dispatch:

jobs:
  build_artifacts:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      release_tag: ${{ steps.setup_vars.outputs.release_tag }}

    steps:
      - name: âœ… Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš™ï¸ Setup Environment Variables
        id: setup_vars
        run: |
          APP_VERSION=$(grep 'version:' pubspec.yaml | sed 's/version: //')
          echo "RELEASE_TAG=v${APP_VERSION}" >> $GITHUB_ENV
          echo "CURRENT_DATE_TIME=$(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV
          echo "release_tag=v${APP_VERSION}" >> $GITHUB_OUTPUT

      - name: ğŸ” Setup Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > /home/runner/work/upload-keystore.jks
          echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" > android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
          echo "storeFile=/home/runner/work/upload-keystore.jks" >> android/key.properties

      - name: ğŸ¦ Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: ğŸ§¼ Clean Project
        run: flutter clean

      - name: ğŸ”„ Get Dependencies
        run: flutter pub get

      - name: ğŸ” Commit pubspec.lock changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(deps): Update pubspec.lock"
          file_pattern: "pubspec.lock"

      - name: ğŸ’ª Build Signed Release APK
        run: |
          flutter build apk --release \
            --dart-define=WEATHER_API_KEY=${{ secrets.WEATHER_API_1 }} \
            --dart-define=WEATHER_API_2=${{ secrets.WEATHER_API_2 }}
        working-directory: ./ 

      - name: ğŸ“¦ Prepare Release Artifacts
        run: |
          mkdir -p release_artifacts
          mv build/app/outputs/flutter-apk/app-release.apk release_artifacts/AuroraWeather-${{ env.RELEASE_TAG }}-signed.apk

      - name: â¬†ï¸ Upload Release Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: app-artifacts
          path: release_artifacts/

      - name: ğŸ§¹ Cleanup Keystore
        if: always()
        run: |
          rm -f /home/runner/work/upload-keystore.jks
          rm -f android/key.properties

  create_release:
    needs: build_artifacts
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
      - name: âœ… Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â¬‡ï¸ Download Release Artifacts
        uses: actions/download-artifact@v4
        with:
          name: app-artifacts
          path: release_artifacts/

      - name: ğŸ“ Generate Changelog
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v2
        with:
          fromTag: ${{ needs.build_artifacts.outputs.release_tag }}
          toTag: ${{ needs.build_artifacts.outputs.release_tag }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸš€ Create GitHub Release & Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build_artifacts.outputs.release_tag }}
          name: "Release ${{ needs.build_artifacts.outputs.release_tag }}"
          body: |
            # âœ¨ Release: AuroraWeather ${{ needs.build_artifacts.outputs.release_tag }}

            Hello there! A new **signed** version of AuroraWeather is now available.

            ## ğŸ” Security
            This release is signed with our production keystore and ready for distribution.

            ## ğŸš€ What's New
            ${{ steps.changelog.outputs.changelog }}

            ## ğŸ“¥ Download
            You can download the latest signed APK from the assets section below.

            ## ğŸ¤ Support & Feedback
            If you encounter any issues or have suggestions, please open an issue on our [GitHub repository](${{ github.server_url }}/${{ github.repository }}).

            Thank you for using AuroraWeather! ğŸŒ¤ï¸
          files: release_artifacts/*